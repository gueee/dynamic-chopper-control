# Dynamic Chopper Control (DCC) — Example Configuration
#
# Add this to your printer.cfg (or include it via [include]).
# Requires a [tmc5160 stepper_x] section to already exist.
#
# DCC reads the motion planner's velocity profile and schedules timed
# TMC register writes at zone boundaries. Each zone carries a complete
# set of chopper field overrides — only specify fields you want to change
# from the static [tmc5160] config.

[dynamic_chopper stepper_x]
enable: True

# Velocity zone boundaries (mm/s, ascending).
# Creates N+1 zones: [0, v1), [v1, v2), ..., [vN, ∞)
zone_velocities: 80, 250

#-----------------------------------------------------------------------
# Zone 0: 0–80 mm/s  —  Low-speed StealthChop
# Gentle PWM regulation, higher toff for quieter operation.
#-----------------------------------------------------------------------
zone_0_toff:          4
zone_0_hstrt:         4
zone_0_hend:          2
zone_0_tbl:           2
zone_0_tpfd:          1
zone_0_en_pwm_mode:   1

#-----------------------------------------------------------------------
# Zone 1: 80–250 mm/s  —  SpreadCycle normal
# Tighter chopper for mid-range. Disable StealthChop.
#-----------------------------------------------------------------------
zone_1_toff:          3
zone_1_hstrt:         4
zone_1_hend:          1
zone_1_tbl:           1
zone_1_tpfd:          1
zone_1_en_pwm_mode:   0

#-----------------------------------------------------------------------
# Zone 2: 250+ mm/s  —  SpreadCycle high speed
# Fast decay, aggressive chopper for high-velocity stability.
#-----------------------------------------------------------------------
zone_2_toff:          2
zone_2_hstrt:         5
zone_2_hend:          0
zone_2_tbl:           0
zone_2_tpfd:          0
zone_2_en_pwm_mode:   0

#-----------------------------------------------------------------------
# Reversal profile — applied during direction changes
# Wider hysteresis, slower decay to reduce impact at zero-crossing.
# At 48V the current slew rate during reversal is extreme; this softens it.
#-----------------------------------------------------------------------
reversal_toff:          5
reversal_hstrt:         2
reversal_hend:          4
reversal_tbl:           2
reversal_tpfd:          0
reversal_en_pwm_mode:   0

# Reduce current to 80% during reversal (minimum 0.5 = 50%)
#reversal_current_scale: 0.8

# Seconds before zero-crossing to apply reversal profile
reversal_lead_time:   0.0005

# Seconds after zero-crossing to hold reversal profile
reversal_hold_time:   0.001

# Seconds before zone crossing to send SPI write (10 µs default)
spi_lead_time:        0.00001


# --- AWD example: second motor on same axis ---
# For AWD setups, add a separate section per stepper.
# Typically uses the same profiles as the primary stepper.

#[dynamic_chopper stepper_x1]
#enable: True
#zone_velocities: 80, 250
#zone_0_toff: 4
#...same as stepper_x...
